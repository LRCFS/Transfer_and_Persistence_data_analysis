---
title: "Persistence Experiments"
author: "Christian Cole"
date: "10/03/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
# libraries
library(readxl)
library(broom)
library(plyr)
library(tidyverse)
library(ggplot2)
library(forcats)
library(tibble)
library(dplyr)
source('lib.R')
```

```{r themes, echo=FALSE}

mytheme = theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.title = element_text(size = 13, face = "bold"),
        axis.text = element_text(size = 11),
        legend.title = element_blank())

inset_theme = theme_minimal() +
  theme(plot.background = element_rect(fill = 'white', colour = 'white'),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 8),
        legend.title = element_blank(),
        legend.position = 'NA')


```

# Analysis of Persistence Experiments

Go through experiment sets and extract the persistence data. The data are
defined by having "ObsType" != "Ndata".

```{r persML}
# Read in ML's data
my.dat = read_xlsx("dat/20191030DatasetPaper.xlsx", sheet = "DataMl")

# only use the persistence experiments for Groups 1 & 2. Groups 3-6 do not 
# have enough replicates to be meaningful
persist.dat = my.dat %>% filter(
      Substrate != 'Cott01' & 
      Group %in% c(1,2) & 
      ObsType != 'Ndata') %>%
  select(c("Substrate", "ObsType", "Count", "Mass", "Duration", "Time", "Group", "Repeat")) %>%
  rename(ObservationType = ObsType, 
         TransferTime = Duration,
         PersistenceTime = Time,
         Experiment = Group,
         Replicate = Repeat)

# fix column types
persist.dat$Count = as.numeric(persist.dat$Count)
persist.dat$PersistenceTime = as.numeric(persist.dat$PersistenceTime)
persist.dat$Experiment = as.character(persist.dat$Experiment)
persist.dat$Replicate = as.character(persist.dat$Replicate)
# some errors in the data, fix
persist.dat[persist.dat$Substrate == 'wool01', 'Substrate'] <- 'Wool'
persist.dat[persist.dat$Substrate == 'Wool01', 'Substrate'] <- 'Wool'
persist.dat[persist.dat$Substrate == 'Nylo01', 'Substrate'] <- 'Nylon'
persist.dat[persist.dat$Substrate == 'Wool' & persist.dat$Experiment == '2', 'Substrate'] <- 'Nylon'

# summarise the count data
summ.dat = summarySE(persist.dat, measurevar = "Count", groupvars = c("Substrate", "PersistenceTime", "Experiment"))
knitr::kable(head(summ.dat), caption = "Summary of ML's Persistence Data")

```

The data covers a large period of time - potentially weeks - so the time
scale needs to be compressed somehow for ease of interpretation. Let's see
what we can do.

```{r mlplots}

p1 = ggplot(summ.dat, aes(x=PersistenceTime, y = Count, group = Substrate, colour = Substrate, shape=Substrate)) +
  geom_point(position = position_dodge(0.3)) +
  geom_errorbar(aes(ymin = Count-se, ymax = Count+se), width = 0.08) +
  xlim(c(-5,1500)) +
  scale_y_continuous(breaks = seq(0,60,10)) +
  labs(title = "Persistence Experiment",
       subtitle = "60s & 1000g Transfer",
       x = "Persistence Time (min)",
       y = "Particle Count") +
  mytheme

p2 = ggplot(summ.dat, aes(x=PersistenceTime, y = Count, group = Substrate, colour = Substrate, shape=Substrate)) +
  geom_point(position = position_dodge(0.3)) +
  geom_errorbar(aes(ymin = Count-se, ymax = Count+se), width = 0.08) +
  labs(x = "Persistence Time (min)",
       y = "Particle Count") +
  inset_theme

p1 + annotation_custom(ggplotGrob(p2), xmin = 700, xmax = 1600, 
                       ymin = 20, ymax = 65)
```

The data seems to be a smooth decay. Let's try some curve-fitting.

This function SSasymp() a self-starting fucntion which attempts to find
suitable initial parameters for perform a fit - here a non-linear least
squares.

Let's see the Nylon fit first

```{r fits, echo=TRUE}
# ideas taken from http://douglas-watson.github.io/post/2018-09_exponential_curve_fitting/
# and https://dataconomy.com/2017/08/nonlinear-least-square-nonlinear-regression-r/
set.seed(12345)
ny.fit = nls(Count ~ SSasymp(PersistenceTime, Countf, Count0, log_alpha), 
             data = summ.dat, 
             subset = Substrate == 'Nylon')
ny.fit.err = summ.dat$Count-predict(ny.fit)
ny.nlm_error <- sqrt(mean(ny.fit.err^2)) 
ny.fit
```

On first impressions the fit looks fine. The residual error is: `r signif(ny.nlm_error)`

A plot of the data and the fit will allow a visual comparison.

```{r fitplt}
p1 = ggplot(summ.dat[summ.dat$Substrate == 'Nylon',], aes(x = PersistenceTime, y = Count)) +
  ggtitle("Nylon Non-Linear Least Squares Fit") +
  geom_point() + 
  geom_errorbar(aes(ymin = Count-se, ymax = Count+se), width = 0.08, data = summ.dat[summ.dat$Substrate == 'Nylon',]) +
  geom_line(aes(y = predict(ny.fit))) +
  xlim(c(-5,1500)) +
  mytheme

p2 = ggplot(summ.dat[summ.dat$Substrate == 'Nylon',], aes(x = PersistenceTime, y = Count)) +
  geom_point() + 
  geom_errorbar(aes(ymin = Count-se, ymax = Count+se), width = 0.08, data = summ.dat[summ.dat$Substrate == 'Nylon',]) +
  geom_line(aes(y = predict(ny.fit))) +
  inset_theme

p1 + annotation_custom(ggplotGrob(p2), xmin = 700, xmax = 1600, 
                       ymin = 20, ymax = 65)
```

The nylon data looks good, let's to the same with the wool data and compare.

```{r woolfit}
wl.fit = nls(Count ~ SSasymp(PersistenceTime, Countf, Count0, log_alpha), 
             data = summ.dat, 
             subset = Substrate == 'Wool')
wl.fit.err = summ.dat$Count-predict(wl.fit)
wl.nlm_error <- sqrt(mean(wl.fit.err^2)) 
wl.fit
```
Residual error:  `r signif(wl.nlm_error)`

```{r woolfitplt}
p1 = ggplot(summ.dat[summ.dat$Substrate == 'Wool',], aes(x = PersistenceTime, y = Count)) +
  ggtitle("Wool Non-Linear Least Squares Fit") +
  geom_point() + 
  geom_errorbar(aes(ymin = Count-se, ymax = Count+se), width = 0.08, data = summ.dat[summ.dat$Substrate == 'Wool',]) +
  geom_line(aes(y = predict(wl.fit))) +
  xlim(c(-5,1500)) +
  mytheme

p2 = ggplot(summ.dat[summ.dat$Substrate == 'Wool',], aes(x = PersistenceTime, y = Count)) +
  geom_point() + 
  geom_errorbar(aes(ymin = Count-se, ymax = Count+se), width = 0.08, data = summ.dat[summ.dat$Substrate == 'Wool',]) +
  geom_line(aes(y = predict(wl.fit))) +
  inset_theme

p1 + annotation_custom(ggplotGrob(p2), xmin = 700, xmax = 1600, 
                       ymin = 10, ymax = 40)
```

```{r}
cmp.fit.dat = summ.dat %>% 
  group_by(Substrate) %>% 
  do(fit = nls(Count ~ SSasymp(PersistenceTime, Countf, Count0, log_alpha), data = .)) %>% 
  tidy(fit) %>% 
  select(Substrate, term, estimate) %>% 
  spread(term, estimate) %>% 
  mutate(alpha = exp(log_alpha))
knitr::kable(cmp.fit.dat)
```

Interestingly the decay rate (alpha) is almost the same for the two materials.

